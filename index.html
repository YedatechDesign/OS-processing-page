<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Processing order</title>
</head>

<body>
  <p>Processing your orderâ€¦</p>

  <script>
    (async function () {
      try {
        // 1. Read params from URL
        const params = new URLSearchParams(window.location.search);
        const submissionId = params.get('submission_id');
        const deliveryType = params.get('delivery_type');

        console.log('submission_id:', submissionId);
        console.log('delivery_type:', deliveryType);

        // 2. Basic validation
        if (!submissionId || !deliveryType) {
          document.body.innerHTML =
            '<p>Missing submission_id or delivery_type</p>';
          return;
        }

        // 3. Call n8n router
        const response = await fetch(
          'https://yedauto.com/webhook/route-order',
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              submission_id: submissionId,
              delivery_type: deliveryType
            })
          }
        );

        console.log('n8n status:', response.status);

        if (!response.ok) {
          document.body.innerHTML =
            '<p>Error contacting server</p>';
          return;
        }

        const data = await response.json();
        console.log('n8n response:', data);

        // 4. Redirect
        if (data.redirectUrl) {
          window.location.href = data.redirectUrl;
        } else {
          document.body.innerHTML =
            '<p>No redirect URL received</p>';
        }

      } catch (err) {
        console.error(err);
        document.body.innerHTML =
          '<p>Unexpected error occurred</p>';
      }
    })();
  </script>
</body>
</html>
